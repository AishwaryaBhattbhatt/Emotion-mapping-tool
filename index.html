<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Mapping Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <style>
        #map { height: 400px; margin-bottom: 20px; }
        #form { margin-top: 20px; }
        .feeling-tag {
            display: inline-block;
            padding: 10px 15px;
            margin: 5px;
            border: 2px solid #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }
        .feeling-tag.selected {
            transform: scale(1.1);
        }
        #save-confirmation {
            display: none;
            color: green;
            margin-top: 10px;
        }
        .field-title {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        #notes {
            width: 100%;
            height: 100px;
        }
        #camera-feed {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background-color: #f0f0f0;
            margin-bottom: 10px;
            object-fit: cover;
        }
        #capture-photo {
            margin-bottom: 15px;
        }
        #save-log {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #save-log:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="form">
        <div class="field-title">Photo:</div>
        <video id="camera-feed" autoplay playsinline></video>
        <button id="capture-photo">Capture Photo</button>
        <canvas id="photo-canvas" style="display:none;"></canvas>
        <div class="field-title">Feeling:</div>
        <div id="feeling-tags">
            <span class="feeling-tag" data-feeling="excited" style="background-color: #b2fe92;">ðŸ˜ƒ Excited</span>
            <span class="feeling-tag" data-feeling="curious" style="background-color: #aaffdd;">ðŸ¤” Curious</span>
            <span class="feeling-tag" data-feeling="happy" style="background-color: #ecfa6f;">ðŸ˜Š Happy</span>
            <span class="feeling-tag" data-feeling="overwhelmed" style="background-color: #fa9c9c;">ðŸ˜µ Overwhelmed</span>
            <span class="feeling-tag" data-feeling="annoyed" style="background-color: #dd8afe;">ðŸ˜  Annoyed</span>
            <span class="feeling-tag" data-feeling="sad" style="background-color: #a4c0ff;">ðŸ˜¢ Sad</span>
        </div>
        <div class="field-title">Notes:</div>
        <textarea id="notes" placeholder="Enter your notes here"></textarea>
        <button id="save-log" onclick="saveLog()">Save Log</button>
        <div id="save-confirmation">Log saved and marker added to the map!</div>
    </div>
    <div id="map"></div>

    <script>
        let map, currentPositionMarker, currentPosition;
        let emotionLogs = [];
        let selectedFeeling = null;
        let capturedPhoto = null;

        const feelingColors = {
            excited: '#b2fe92',
            curious: '#aaffdd',
            happy: '#ecfa6f',
            overwhelmed: '#fa9c9c',
            annoyed: '#dd8afe',
            sad: '#a4c0ff'
        };

        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentPosition = [position.coords.latitude, position.coords.longitude];
                    map.setView(currentPosition, 13);
                    currentPositionMarker = L.marker(currentPosition).addTo(map);
                    currentPositionMarker.bindPopup("Your current location").openPopup();
                }, function(error) {
                    console.error("Error: " + error.message);
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
            }

            initFeelingTags();
            initCamera();
        }

        function initFeelingTags() {
            const tags = document.querySelectorAll('.feeling-tag');
            tags.forEach(tag => {
                tag.addEventListener('click', function() {
                    tags.forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedFeeling = this.dataset.feeling;
                });
            });
        }

        function initCamera() {
            const video = document.getElementById('camera-feed');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(error => {
                    console.error("Error accessing the camera:", error);
                });

            document.getElementById('capture-photo').addEventListener('click', function() {
                const canvas = document.getElementById('photo-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                capturedPhoto = canvas.toDataURL('image/jpeg');
                video.pause();
                video.style.backgroundImage = `url(${capturedPhoto})`;
                video.style.backgroundSize = 'cover';
                video.style.backgroundPosition = 'center';
                alert("Photo captured!");
            });
        }

        function saveLog() {
            if (!currentPosition) {
                alert("Unable to get your current location. Please try again.");
                return;
            }

            if (!selectedFeeling) {
                alert("Please select a feeling before saving.");
                return;
            }

            const notes = document.getElementById('notes').value;

            const log = {
                position: currentPosition,
                feeling: selectedFeeling,
                notes: notes,
                photo: capturedPhoto
            };

            emotionLogs.push(log);
            addLogToMap(log);

            document.getElementById('notes').value = '';
            document.querySelectorAll('.feeling-tag').forEach(tag => tag.classList.remove('selected'));
            selectedFeeling = null;
            capturedPhoto = null;

            const saveConfirmation = document.getElementById('save-confirmation');
            saveConfirmation.style.display = 'block';
            setTimeout(() => {
                saveConfirmation.style.display = 'none';
            }, 3000);
        }

        function addLogToMap(log) {
            const popupContent = `
                <div style="background-color: ${feelingColors[log.feeling]}; padding: 10px; border-radius: 5px;">
                    ${log.photo ? `<img src="${log.photo}" alt="Captured photo" style="max-width: 100px; max-height: 100px;"><br>` : ''}
                    <strong>Feeling:</strong> ${log.feeling}<br>
                    <strong>Notes:</strong> ${log.notes}
                </div>
            `;

            const markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:${feelingColors[log.feeling]};' class='marker-pin'></div>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });

            const marker = L.marker([log.position[0] + Math.random() * 0.0001, log.position[1] + Math.random() * 0.0001], {icon: markerIcon}).addTo(map);
            marker.bindPopup(popupContent).openPopup();
        }

        window.onload = initMap;
    </script>
</body>
</html>
