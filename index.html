<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Mapping Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <style>
        #map { height: 400px; margin-bottom: 20px; }
        #form { margin-top: 20px; }
        .feeling-tag {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .feeling-tag.selected {
            color: white;
        }
        .feeling-tag .emoticon {
            font-size: 1.2em;
            margin-right: 5px;
        }
        #save-confirmation {
            display: none;
            color: green;
            margin-top: 10px;
        }
        .field-title {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        #camera-container {
            width: 320px;
            height: 240px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        #capture-photo {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="form">
        <div class="field-title">Feeling:</div>
        <div id="feeling-tags">
            <span class="feeling-tag" data-feeling="happy" style="background-color: #FFD700;">
                <span class="emoticon">ðŸ˜Š</span>Happy
            </span>
            <span class="feeling-tag" data-feeling="curious" style="background-color: #4B0082;">
                <span class="emoticon">ðŸ¤”</span>Curious
            </span>
            <span class="feeling-tag" data-feeling="excited" style="background-color: #FF4500;">
                <span class="emoticon">ðŸ˜ƒ</span>Excited
            </span>
            <span class="feeling-tag" data-feeling="overwhelmed" style="background-color: #800080;">
                <span class="emoticon">ðŸ˜µ</span>Overwhelmed
            </span>
            <span class="feeling-tag" data-feeling="annoyed" style="background-color: #FF6347;">
                <span class="emoticon">ðŸ˜ </span>Annoyed
            </span>
            <span class="feeling-tag" data-feeling="sad" style="background-color: #4682B4;">
                <span class="emoticon">ðŸ˜¢</span>Sad
            </span>
        </div>
        <div class="field-title">Notes:</div>
        <textarea id="notes" placeholder="Enter your notes here"></textarea>
        <div class="field-title">Photo:</div>
        <div id="camera-container">
            <video id="video" width="320" height="240" autoplay></video>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
        </div>
        <button id="capture-photo">Capture Photo</button>
        <button onclick="saveLog()">Save Log</button>
        <div id="save-confirmation">Log saved and marker added to the map!</div>
    </div>

    <script>
        let map, currentPositionMarker, currentPosition;
        let emotionLogs = [];
        let selectedFeeling = null;
        let capturedPhoto = null;

        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentPosition = [position.coords.latitude, position.coords.longitude];
                    map.setView(currentPosition, 13);
                    currentPositionMarker = L.marker(currentPosition).addTo(map);
                    currentPositionMarker.bindPopup("Your current location").openPopup();
                }, function(error) {
                    console.error("Error: " + error.message);
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
            }

            initFeelingTags();
            initCamera();
        }

        function initFeelingTags() {
            const tags = document.querySelectorAll('.feeling-tag');
            tags.forEach(tag => {
                tag.addEventListener('click', function() {
                    tags.forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedFeeling = this.dataset.feeling;
                });
            });
        }

        function initCamera() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const captureButton = document.getElementById('capture-photo');

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.error("Error accessing the camera", err);
                });

            captureButton.addEventListener('click', () => {
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                capturedPhoto = canvas.toDataURL('image/jpeg');
                console.log("Photo captured");
            });
        }

        function saveLog() {
            if (!currentPosition) {
                alert("Unable to get your current location. Please try again.");
                return;
            }

            if (!selectedFeeling) {
                alert("Please select a feeling before saving.");
                return;
            }

            const notes = document.getElementById('notes').value;

            const log = {
                position: currentPosition,
                feeling: selectedFeeling,
                notes: notes,
                photo: capturedPhoto
            };

            emotionLogs.push(log);
            addLogToMap(log);
            
            document.getElementById('notes').value = '';
            document.querySelectorAll('.feeling-tag').forEach(tag => tag.classList.remove('selected'));
            selectedFeeling = null;
            capturedPhoto = null;

            // Show save confirmation
            const saveConfirmation = document.getElementById('save-confirmation');
            saveConfirmation.style.display = 'block';
            setTimeout(() => {
                saveConfirmation.style.display = 'none';
            }, 3000);
        }

        function addLogToMap(log) {
            const popupContent = `
                <strong>Feeling:</strong> ${log.feeling}<br>
                <strong>Notes:</strong> ${log.notes}<br>
                ${log.photo ? `<strong>Photo:</strong><br><img src="${log.photo}" alt="Captured photo" style="max-width: 100px; max-height: 100px;">` : ''}
            `;

            const markerColor = getMarkerColor(log.feeling);
            const markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:${markerColor};' class='marker-pin'></div>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });

            L.marker(log.position, {icon: markerIcon}).addTo(map)
                .bindPopup(popupContent)
                .openPopup();
        }

        function getMarkerColor(feeling) {
            const colors = {
                happy: '#FFD700',
                curious: '#4B0082',
                excited: '#FF4500',
                overwhelmed: '#800080',
                annoyed: '#FF6347',
                sad: '#4682B4'
            };
            return colors[feeling] || '#000000';
        }

        window.onload = initMap;
    </script>
</body>
</html>