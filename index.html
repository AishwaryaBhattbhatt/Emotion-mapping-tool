<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Mapping Tool</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR3nhIW56taOqanoBa0I4nVJiiUvQylf4"></script>
    <style>
        #map { height: 400px; margin-bottom: 20px; }
        #form { margin-top: 20px; }
        .feeling-tag {
            display: inline-block;
            padding: 10px 15px;
            margin: 5px;
            border: 2px solid #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }
        .feeling-tag.selected {
            transform: scale(1.1);
        }
        #save-confirmation {
            display: none;
            color: green;
            margin-top: 10px;
        }
        .field-title {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        #notes {
            width: 100%;
            height: 100px;
        }
        #camera-feed {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background-color: #f0f0f0;
            margin-bottom: 10px;
            object-fit: cover;
        }
        #capture-photo {
            margin-bottom: 15px;
        }
        #save-log, #restart-logging, #play-pause-animation {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #save-log:hover, #restart-logging:hover, #play-pause-animation:hover {
            background-color: #0056b3;
        }
        .toggle-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
        }
        .toggle-button.off {
            background-color: #d9534f;
        }
        #manual-log-form {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        #manual-log-form input, #manual-log-form textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div>
        <button id="toggle-gps" class="toggle-button" onclick="toggleGPS()">GPS: Off</button>
        <button id="toggle-camera" class="toggle-button" onclick="toggleCamera()">Camera: Off</button>
    </div>
    <div id="form">
        <div class="field-title">Photo:</div>
        <video id="camera-feed" autoplay playsinline></video>
        <button id="capture-photo">Capture Photo</button>
        <canvas id="photo-canvas" style="display:none;"></canvas>
        <div class="field-title">Feeling:</div>
        <div id="feeling-tags">
            <span class="feeling-tag" data-feeling="excited" style="background-color: #b2fe92;">ðŸ˜ƒ Excited</span>
            <span class="feeling-tag" data-feeling="curious" style="background-color: #aaffdd;">ðŸ¤” Curious</span>
            <span class="feeling-tag" data-feeling="happy" style="background-color: #ecfa6f;">ðŸ˜Š Happy</span>
            <span class="feeling-tag" data-feeling="overwhelmed" style="background-color: #fa9c9c;">ðŸ˜µ Overwhelmed</span>
            <span class="feeling-tag" data-feeling="annoyed" style="background-color: #dd8afe;">ðŸ˜  Annoyed</span>
            <span class="feeling-tag" data-feeling="sad" style="background-color: #a4c0ff;">ðŸ˜¢ Sad</span>
        </div>
        <div class="field-title">Notes:</div>
        <textarea id="notes" placeholder="Enter your notes here"></textarea>
        <button id="save-log" onclick="saveLog()">Save Log</button>
        <button id="restart-logging" onclick="restartLogging()">Restart Logging</button>
        <button id="play-pause-animation" onclick="toggleAnimation()">Play Journey</button>
        <div id="save-confirmation">Log saved and marker added to the map!</div>
    </div>
    <div id="map"></div>

    <div id="manual-log-form">
        <h3>Log a Feeling</h3>
        <div class="field-title">Feeling:</div>
        <div id="manual-feeling-tags">
            <span class="feeling-tag" data-feeling="excited" style="background-color: #b2fe92;">ðŸ˜ƒ Excited</span>
            <span class="feeling-tag" data-feeling="curious" style="background-color: #aaffdd;">ðŸ¤” Curious</span>
            <span class="feeling-tag" data-feeling="happy" style="background-color: #ecfa6f;">ðŸ˜Š Happy</span>
            <span class="feeling-tag" data-feeling="overwhelmed" style="background-color: #fa9c9c;">ðŸ˜µ Overwhelmed</span>
            <span class="feeling-tag" data-feeling="annoyed" style="background-color: #dd8afe;">ðŸ˜  Annoyed</span>
            <span class="feeling-tag" data-feeling="sad" style="background-color: #a4c0ff;">ðŸ˜¢ Sad</span>
        </div>
        <div class="field-title">Notes:</div>
        <textarea id="manual-notes" placeholder="Enter your notes here"></textarea>
        <div class="field-title">Upload Photo:</div>
        <input type="file" id="manual-photo" accept="image/*">
        <button onclick="saveManualLog()">Save Log</button>
        <button onclick="closeManualLogForm()">Cancel</button>
    </div>

    <script>
        let map, currentPositionMarker, currentPositionCircle;
        let emotionLogs = JSON.parse(localStorage.getItem('emotionLogs')) || [];
        let selectedFeeling = null;
        let capturedPhoto = null;
        let stream;
        let gpsEnabled = false;
        let watchId;
        let manualLogPosition = null;
        let animationInterval;
        let animationPlaying = false;
        let animationIndex = 0;
        let animationMarkers = [];

        const feelingColors = {
            excited: '#b2fe92',
            curious: '#aaffdd',
            happy: '#ecfa6f',
            overwhelmed: '#fa9c9c',
            annoyed: '#dd8afe',
            sad: '#a4c0ff'
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 43.650795, lng: -79.398091 }
            });

            map.addListener('click', function(e) {
                openManualLogForm(e.latLng);
            });

            initFeelingTags();
            initCamera();
            loadLogs();
        }

        function toggleGPS() {
            gpsEnabled = !gpsEnabled;
            const button = document.getElementById('toggle-gps');
            if (gpsEnabled) {
                button.textContent = 'GPS: On';
                button.classList.remove('off');
                requestLocation();
            } else {
                button.textContent = 'GPS: Off';
                button.classList.add('off');
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                if (currentPositionMarker) {
                    currentPositionMarker.setMap(null);
                    currentPositionMarker = null;
                }
                if (currentPositionCircle) {
                    currentPositionCircle.setMap(null);
                    currentPositionCircle = null;
                }
            }
        }

        function requestLocation() {
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(function(position) {
                    const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    map.setCenter(pos);
                    if (currentPositionMarker) {
                        currentPositionMarker.setPosition(pos);
                    } else {
                        currentPositionMarker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: 'Current Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: 'blue',
                                fillOpacity: 1,
                                strokeWeight: 2,
                                strokeColor: 'white'
                            }
                        });
                    }
                    addCurrentPositionCircle(pos);
                }, function(error) {
                    console.error("Error: " + error.message);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }

        function addCurrentPositionCircle(position) {
            if (currentPositionCircle) {
                currentPositionCircle.setMap(null);
            }
            currentPositionCircle = new google.maps.Circle({
                strokeColor: '#0000FF',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#0000FF',
                fillOpacity: 0.35,
                map: map,
                center: position,
                radius: 5 // 5 meters radius
            });
        }

        function toggleCamera() {
            const button = document.getElementById('toggle-camera');
            const video = document.getElementById('camera-feed');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                button.textContent = 'Camera: Off';
                button.classList.add('off');
            } else {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(s => {
                        stream = s;
                        video.srcObject = stream;
                        button.textContent = 'Camera: On';
                        button.classList.remove('off');
                    })
                    .catch(error => {
                        console.error("Error accessing the camera:", error);
                    });
            }
        }

        function initFeelingTags() {
            const tags = document.querySelectorAll('.feeling-tag');
            tags.forEach(tag => {
                tag.addEventListener('click', function() {
                    tags.forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedFeeling = this.dataset.feeling;
                });
            });
        }

        function initCamera() {
            const video = document.getElementById('camera-feed');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                    document.getElementById('toggle-camera').textContent = 'Camera: On';
                })
                .catch(error => {
                    console.error("Error accessing the camera:", error);
                });

            document.getElementById('capture-photo').addEventListener('click', function() {
                const canvas = document.getElementById('photo-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                capturedPhoto = canvas.toDataURL('image/jpeg');
                video.pause();
                video.style.backgroundImage = `url(${capturedPhoto})`;
                video.style.backgroundSize = 'cover';
                video.style.backgroundPosition = 'center';
                video.style.display = 'block';
                alert("Photo captured!");
            });
        }

        function saveLog() {
            if (!currentPositionMarker) {
                alert("Unable to get your current location. Please try again.");
                return;
            }

            if (!selectedFeeling) {
                alert("Please select a feeling before saving.");
                return;
            }

            const notes = document.getElementById('notes').value;
            const position = currentPositionMarker.getPosition();

            const log = {
                position: { lat: position.lat(), lng: position.lng() },
                feeling: selectedFeeling,
                notes: notes,
                photo: capturedPhoto,
                timestamp: new Date().toISOString()
            };

            emotionLogs.push(log);
            localStorage.setItem('emotionLogs', JSON.stringify(emotionLogs));
            addLogToMap(log);

            document.getElementById('notes').value = '';
            document.querySelectorAll('.feeling-tag').forEach(tag => tag.classList.remove('selected'));
            selectedFeeling = null;
            capturedPhoto = null;
            restartCamera();

            const saveConfirmation = document.getElementById('save-confirmation');
            saveConfirmation.style.display = 'block';
            setTimeout(() => {
                saveConfirmation.style.display = 'none';
            }, 3000);
        }

        function addLogToMap(log) {
            const popupContent = `
                <div style="background-color: ${feelingColors[log.feeling]}; padding: 10px; border-radius: 5px;">
                    ${log.photo ? `<img src="${log.photo}" alt="Captured photo" style="max-width: 100px; max-height: 100px;"><br>` : ''}
                    <strong>Feeling:</strong> ${log.feeling}<br>
                    <strong>Notes:</strong> ${log.notes}
                </div>
            `;

            const marker = new google.maps.Marker({
                position: log.position,
                map: map,
                title: log.feeling,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: feelingColors[log.feeling],
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: 'white'
                }
            });

            const infowindow = new google.maps.InfoWindow({
                content: popupContent
            });

            marker.addListener('click', () => {
                infowindow.open(map, marker);
            });
        }

        function loadLogs() {
            emotionLogs.forEach(log => addLogToMap(log));
        }

        function restartCamera() {
            const video = document.getElementById('camera-feed');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                    video.play();
                    video.style.backgroundImage = 'none';
                })
                .catch(error => {
                    console.error("Error accessing the camera:", error);
                });
        }

        function restartLogging() {
            localStorage.removeItem('emotionLogs');
            emotionLogs = [];
            // Clear all markers from the map
            initMap();
        }

        function openManualLogForm(latLng) {
            manualLogPosition = latLng;
            document.getElementById('manual-log-form').style.display = 'block';
        }

        function closeManualLogForm() {
            document.getElementById('manual-log-form').style.display = 'none';
            manualLogPosition = null;
        }

        function saveManualLog() {
            const feelingTags = document.querySelectorAll('#manual-feeling-tags .feeling-tag');
            let manualSelectedFeeling = null;
            feelingTags.forEach(tag => {
                if (tag.classList.contains('selected')) {
                    manualSelectedFeeling = tag.dataset.feeling;
                }
            });

            if (!manualSelectedFeeling) {
                alert("Please select a feeling before saving.");
                return;
            }

            const notes = document.getElementById('manual-notes').value;
            const photoInput = document.getElementById('manual-photo');
            let photo = null;

            if (photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photo = e.target.result;
                    const log = {
                        position: { lat: manualLogPosition.lat(), lng: manualLogPosition.lng() },
                        feeling: manualSelectedFeeling,
                        notes: notes,
                        photo: photo,
                        timestamp: new Date().toISOString()
                    };

                    emotionLogs.push(log);
                    localStorage.setItem('emotionLogs', JSON.stringify(emotionLogs));
                    addLogToMap(log);

                    document.getElementById('manual-notes').value = '';
                    photoInput.value = '';
                    feelingTags.forEach(tag => tag.classList.remove('selected'));
                    closeManualLogForm();
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                const log = {
                    position: { lat: manualLogPosition.lat(), lng: manualLogPosition.lng() },
                    feeling: manualSelectedFeeling,
                    notes: notes,
                    photo: null, // No photo for manual logs if not uploaded
                    timestamp: new Date().toISOString()
                };

                emotionLogs.push(log);
                localStorage.setItem('emotionLogs', JSON.stringify(emotionLogs));
                addLogToMap(log);

                document.getElementById('manual-notes').value = '';
                photoInput.value = '';
                feelingTags.forEach(tag => tag.classList.remove('selected'));
                closeManualLogForm();
            }
        }

        function toggleAnimation() {
            if (animationPlaying) {
                clearInterval(animationInterval);
                document.getElementById('play-pause-animation').textContent = 'Play Journey';
                animationPlaying = false;
                animationMarkers.forEach(marker => marker.setMap(null));
                animationMarkers = [];
            } else {
                animationIndex = 0;
                document.getElementById('play-pause-animation').textContent = 'Pause Journey';
                animationPlaying = true;
                animationInterval = setInterval(playJourney, 1000);
            }
        }

        function playJourney() {
            if (animationIndex >= emotionLogs.length) {
                clearInterval(animationInterval);
                document.getElementById('play-pause-animation').textContent = 'Play Journey';
                animationPlaying = false;
                return;
            }

            const log = emotionLogs[animationIndex];
            map.setCenter(log.position);
            const marker = new google.maps.Marker({
                position: log.position,
                map: map,
                title: log.feeling,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: feelingColors[log.feeling],
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: 'white'
                }
            });

            animationMarkers.push(marker);
            animateMarker(marker);
            animationIndex++;
        }

        function animateMarker(marker) {
            let growing = true;
            let scale = 10;
            const maxScale = 50;
            const minScale = 10;

            const animation = setInterval(() => {
                if (growing) {
                    scale += 2;
                    if (scale >= maxScale) {
                        growing = false;
                    }
                } else {
                    scale -= 2;
                    if (scale <= minScale) {
                        clearInterval(animation);
                    }
                }

                marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: scale,
                    fillColor: marker.getIcon().fillColor,
                    fillOpacity: marker.getIcon().fillOpacity,
                    strokeWeight: marker.getIcon().strokeWeight,
                    strokeColor: marker.getIcon().strokeColor
                });
            }, 50);
        }

        window.onload = initMap;
    </script>
</body>
</html>
