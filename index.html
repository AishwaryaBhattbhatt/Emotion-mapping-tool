<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Mapping Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <style>
        #map { height: 400px; margin-bottom: 20px; }
        #form { margin-top: 20px; }
        .feeling-tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .feeling-tag.selected {
            color: black;
        }
        #save-confirmation {
            display: none;
            color: green;
            margin-top: 10px;
        }
        .field-title {
            font-weight: bold;
            margin-top: 10px;
        }
        #capturedPhoto {
            max-width: 200px;
            max-height: 200px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="form">
        <div class="field-title">Feeling:</div>
        <div id="feeling-tags">
            <span class="feeling-tag" data-feeling="excited" style="background-color: #b2fe92;">ðŸ˜ƒ Excited</span>
            <span class="feeling-tag" data-feeling="curious" style="background-color: #aaffdd;">ðŸ¤” Curious</span>
            <span class="feeling-tag" data-feeling="happy" style="background-color: #ecfa6f;">ðŸ˜Š Happy</span>
            <span class="feeling-tag" data-feeling="overwhelmed" style="background-color: #fa9c9c;">ðŸ˜° Overwhelmed</span>
            <span class="feeling-tag" data-feeling="annoyed" style="background-color: #dd8afe;">ðŸ˜  Annoyed</span>
            <span class="feeling-tag" data-feeling="sad" style="background-color: #a4c0ff;">ðŸ˜¢ Sad</span>
        </div>
        <div class="field-title">Notes:</div>
        <textarea id="notes" placeholder="Enter your notes here"></textarea>
        <div class="field-title">Photo:</div>
        <button id="capturePhotoBtn">Capture Photo</button>
        <video id="video" style="display:none;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="capturedPhoto" alt="Captured photo">
        <button onclick="saveLog()">Save Log</button>
        <div id="save-confirmation">Log saved and marker added to the map!</div>
    </div>

    <script>
        let map, currentPositionMarker, currentPosition;
        let emotionLogs = [];
        let selectedFeeling = null;
        let capturedImage = null;

        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentPosition = [position.coords.latitude, position.coords.longitude];
                    map.setView(currentPosition, 13);
                    currentPositionMarker = L.marker(currentPosition).addTo(map);
                    currentPositionMarker.bindPopup("Your current location").openPopup();
                }, function(error) {
                    console.error("Error: " + error.message);
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
            }

            initFeelingTags();
            initCameraCapture();
        }

        function initFeelingTags() {
            const tags = document.querySelectorAll('.feeling-tag');
            tags.forEach(tag => {
                tag.addEventListener('click', function() {
                    tags.forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedFeeling = this.dataset.feeling;
                });
            });
        }

        function initCameraCapture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const capturedPhoto = document.getElementById('capturedPhoto');

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(err => {
                    console.error("Error accessing the camera", err);
                });

            capturePhotoBtn.addEventListener('click', function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                capturedImage = canvas.toDataURL('image/jpeg');
                capturedPhoto.src = capturedImage;
                capturedPhoto.style.display = 'block';
            });
        }

        function saveLog() {
            if (!currentPosition) {
                alert("Unable to get your current location. Please try again.");
                return;
            }

            if (!selectedFeeling) {
                alert("Please select a feeling before saving.");
                return;
            }

            const notes = document.getElementById('notes').value;
            
            const log = {
                position: currentPosition,
                feeling: selectedFeeling,
                notes: notes,
                photo: capturedImage
            };

            emotionLogs.push(log);
            addLogToMap(log);
            
            document.getElementById('notes').value = '';
            document.querySelectorAll('.feeling-tag').forEach(tag => tag.classList.remove('selected'));
            selectedFeeling = null;
            capturedImage = null;
            document.getElementById('capturedPhoto').style.display = 'none';

            // Show save confirmation
            const saveConfirmation = document.getElementById('save-confirmation');
            saveConfirmation.style.display = 'block';
            setTimeout(() => {
                saveConfirmation.style.display = 'none';
            }, 3000);
        }

        function addLogToMap(log) {
            const popupContent = `
                <strong>Feeling:</strong> ${getEmoticonForFeeling(log.feeling)} ${log.feeling}<br>
                <strong>Notes:</strong> ${log.notes}<br>
                ${log.photo ? `<strong>Photo:</strong><br><img src="${log.photo}" alt="Captured photo" style="max-width: 100px; max-height: 100px;">` : ''}
            `;

            const markerColor = getMarkerColor(log.feeling);
            const markerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:${markerColor};' class='marker-pin'>${getEmoticonForFeeling(log.feeling)}</div>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42]
            });

            L.marker(log.position, {icon: markerIcon}).addTo(map)
                .bindPopup(popupContent)
                .openPopup();
        }

        function getMarkerColor(feeling) {
            const colors = {
                excited: '#b2fe92',
                curious: '#aaffdd',
                happy: '#ecfa6f',
                overwhelmed: '#fa9c9c',
                annoyed: '#dd8afe',
                sad: '#a4c0ff'
            };
            return colors[feeling] || '#000000'; // Default to black if feeling not found
        }

        function getEmoticonForFeeling(feeling) {
            const emoticons = {
                excited: 'ðŸ˜ƒ',
                curious: 'ðŸ¤”',
                happy: 'ðŸ˜Š',
                overwhelmed: 'ðŸ˜°',
                annoyed: 'ðŸ˜ ',
                sad: 'ðŸ˜¢'
            };
            return emoticons[feeling] || '';
        }

        window.onload = initMap;
    </script>
</body>
</html>